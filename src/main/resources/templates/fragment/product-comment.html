<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div th:fragment="product-comment">
		<section id="comments" class="mt-4" style="margin-top: 24px;">
			<h3 style="margin: 16px 0;">Bình luận</h3>

			<!-- THÔNG BÁO LỖI/THÀNH CÔNG TỪ QUERY PARAM -->
			<div th:if="${param.error != null}"
				style="padding: 10px 12px; border: 1px solid #f5c2c7; background: #f8d7da; color: #842029; border-radius: 8px; margin-bottom: 12px;">
				<span th:if="${param.error[0] == 'empty_comment'}">Vui lòng
					nhập nội dung bình luận.</span> <span
					th:if="${param.error[0] == 'comment_save_failed'}">Không lưu
					được bình luận. Hãy thử lại.</span> <span
					th:if="${param.error[0] == 'comment_not_found'}">Không tìm
					thấy bình luận.</span> <span
					th:if="${param.error[0] == 'already_commented'}">Bạn đã bình
					luận cho sản phẩm này.</span> <span
					th:if="${param.error[0] == 'forbidden'}">Bạn không có quyền
					thao tác này.</span> <span th:if="${param.error[0] == 'update_failed'}">Cập
					nhật bình luận không thành công.</span> <span
					th:if="${param.error[0] == 'delete_failed'}">Xoá bình luận
					không thành công.</span> <span
					th:if="${param.error[0] == 'user_not_found'}">Không tìm thấy
					người dùng.</span> <span th:if="${param.error[0] == 'product_not_found'}">Không
					tìm thấy sản phẩm.</span>
			</div>

			<!-- SỐ LƯỢNG -->
			<div style="opacity: .75; margin-bottom: 8px;"
				th:text="${#lists.isEmpty(comments) ? 'Chưa có bình luận nào.' : #lists.size(comments) + ' bình luận'}">
			</div>

			<!-- DANH SÁCH BÌNH LUẬN -->
			<ul class="list-unstyled" style="padding-left: 0; margin: 0;"
				th:if="${comments != null and !#lists.isEmpty(comments)}">
				<li th:each="c : ${comments}"
					style="border-bottom: 1px solid #eee; padding: 12px 0;">
					<div style="display: flex; gap: 10px; align-items: flex-start;">
						<!-- Avatar -->
						<div
							style="width: 36px; height: 36px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-weight: 600;">
							<span
								th:text="${(c.user != null and c.user.username != null and c.user.username != '') 
									                              ? #strings.substring(c.user.username,0,1).toUpperCase()
									                              : 'U'}">U</span>
						</div>

						<div style="flex: 1;">
							<div
								style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
								<strong
									th:text="${(c.user != null and c.user.username != null and c.user.username != '') 
									                                ? c.user.username : 'Người dùng'}">Người
									dùng</strong> <small style="color: #666;"
									th:text="${c.datePost != null ? #dates.format(c.datePost, 'dd/MM/yyyy') : ''}"></small>
							</div>

							<div style="margin-top: 6px; white-space: pre-wrap;"
								th:text="${c.content}">Nội dung bình luận...</div>

							<!-- Hành động (ẩn 'Sửa' nếu bạn chưa có trang edit) -->
							<div style="margin-top: 8px; display: flex; gap: 8px;">
								<!-- SỬA: chỉ hiển thị nếu bạn có template comments/edit.html -->
								<!--
									            <a class="btn btn-sm btn-outline-secondary"
									               th:href="@{/comments/{id}/edit(id=${c.id})}"
									               sec:authorize="hasRole('USER') and ${c.user != null and c.user.username == #authentication.name}">
									              Sửa
									            </a>
									            -->

								<!-- XOÁ: chỉ ADMIN (nếu đã làm chức năng xoá) -->
								<!--
									            <form th:action="@{/comments/{id}/delete(id=${c.id})}" method="post"
									                  sec:authorize="hasRole('ADMIN')" style="display:inline;">
									              <input th:if="${_csrf != null}" type="hidden"
									                     th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
									              <button type="submit" class="btn btn-sm btn-outline-danger"
									                      onclick="return confirm('Xoá bình luận này?')">Xoá</button>
									            </form>
									            -->
							</div>
						</div>
					</div>
				</li>
			</ul>

			<!-- FORM TẠO BÌNH LUẬN: chỉ USER -->
			<div sec:authorize="hasRole('USER')" style="margin-top: 16px;">
				<h4 style="font-size: 16px; margin-bottom: 8px;">Viết bình luận
					của bạn</h4>
				<form th:action="@{/san-pham/{id}/comments(id=${product.name})}"
					method="post">
					<input th:if="${_csrf != null}" type="hidden"
						th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
					<textarea name="content" rows="4" maxlength="1000" required
						class="form-control" placeholder="Nhập bình luận..."></textarea>
					<div style="margin-top: 8px;">
						<button type="submit" class="btn btn-primary">Gửi</button>
					</div>
				</form>
			</div>

			<!-- NHẮC ĐĂNG NHẬP -->
			<div sec:authorize="!hasRole('USER')" style="margin-top: 8px;">
				<a th:href="@{/login}">Đăng nhập</a> để bình luận.
			</div>
		</section>
	</div>
</body>
</html>