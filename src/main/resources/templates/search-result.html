<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kết quả tìm kiếm sản phẩm</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/sign.css}">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" th:href="@{/plugins/uikit/uikit.min.css}">
  <script th:src="@{/plugins/uikit/uikit.min.js}"></script>
  <script th:src="@{/plugins/uikit/uikit-icons.min.js}"></script>

  <style>
    body{min-height:100vh;margin:0}
    .page{min-height:100vh;display:flex;flex-direction:column}
    main{flex:1 0 auto}
    @media (min-width: 992px){ .sticky-sidebar{position:sticky;top:5rem} }
    .img-swap img + img { opacity:0; transition:opacity .25s ease; }
    .img-swap:hover img + img { opacity:1; }
  </style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <div th:replace="~{/fragment/header.html :: header}"></div>

  <!-- Main -->
  <main class="container-fluid px-0 py-4">
    <div class="row gx-0 gy-4 align-items-stretch">

      <!-- Nội dung tìm kiếm -->
      <section class="col-12 col-lg-9 pe-lg-4">
        <h2 class="mb-4">Kết quả tìm kiếm</h2>

        <!-- Không có kết quả -->
        <div th:if="${products == null or #lists.isEmpty(products)}" class="alert alert-info">
          Không tìm thấy sản phẩm nào phù hợp với từ khóa tìm kiếm.
        </div>

        <!-- Có kết quả -->
        <div th:if="${products != null and !#lists.isEmpty(products)}"
             class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">

          <div th:each="product : ${products}" class="col">
            <div class="card h-100 border-0 shadow-sm">

              <!-- LINK + ẢNH (dùng product.name trong path) -->
              <a th:href="@{/san-pham/{id}(id=${product.name})}"
                 th:title="${product.name}"
                 class="img-resize d-block position-relative overflow-hidden img-swap">

                <!-- Ảnh chính từ S3 (fallback) -->
                <img th:src="${product.image != null}
                              ? @{|https://s3.cloudfly.vn/kltn/images/${product.image}|}
                              : @{/images/default-product.jpg}"
                     th:alt="${product.name}"
                     class="w-100"
                     loading="lazy"
                     style="aspect-ratio:1/1;object-fit:cover;">

                <!-- Ảnh hover phụ (giữ như mẫu của bạn) -->
                <img th:src="@{/images/drink/drink fade 1.jpg}"
                     th:alt="${product.name}"
                     class="w-100 position-absolute top-0 start-0 h-100"
                     loading="lazy"
                     style="object-fit:cover;">
              </a>

              <div class="card-body p-2 d-flex flex-column">
                <h6 class="mb-1 text-truncate" th:text="${product.name}">Tên sản phẩm</h6>
                <div class="small text-muted"
                     th:text="${product.category != null ? product.category.name : 'Chưa phân loại'}">
                  Danh mục
                </div>
                <div class="fw-semibold mt-1"
                     th:text="${product.lowestPrice > 0 ? #numbers.formatDecimal(product.lowestPrice,0,'COMMA',0,'NONE') + ' VND' : 'Liên hệ'}">
                  0 VND
                </div>

                <div class="mt-auto pt-2">
                  <a th:href="@{/san-pham/{id}(id=${product.name})}" class="btn btn-primary w-100">Xem chi tiết</a>
                </div>
              </div>

            </div>
          </div>

        </div>

        <!-- Điều hướng -->
        <div class="mt-4 d-flex gap-2">
          <a th:href="@{/}" class="btn btn-secondary">Quay lại trang chủ</a>
          <!--<a id="retryLink" href="#" class="btn btn-outline-primary">Tìm kiếm lại</a>-->
        </div>
      </section>

      <!-- Sidebar phải -->
      <aside class="col-12 col-lg-3 px-0">
        <div class="sticky-sidebar h-100">
          <div class="card rounded-3">
            <div class="card-body">
              <h5 class="card-title mb-3">Sản phẩm liên quan</h5>
              <ul class="list-unstyled mb-0">
                <li th:each="p : ${featuredProducts}">
                  <a th:href="@{/san-pham/{id}(id=${p.name})}" th:text="${p.name}">Tên SP</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <!-- Footer -->
  <div th:replace="~{/fragment/footer.html :: footer}"></div>
</div>

<script>
  // Gán lại link "Tìm kiếm lại" dựa trên path hiện tại (/search/{content})
  (function(){
    try {
      var segs = window.location.pathname.split('/');
      var content = decodeURIComponent(segs[segs.length - 1] || '');
      var a = document.getElementById('retryLink');
      if (a && content) a.href = '/search/' + encodeURIComponent(content);
    } catch (e) {}
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
